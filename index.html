<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agita Esportivo SENAI Mar√≠lia</title>
    <!-- Favicon adicionado para um toque profissional -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .bounce-in { animation: bounceIn 0.6s ease-out; }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .pulse-glow { animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 83, 159, 0.5); }
            50% { box-shadow: 0 0 30px rgba(0, 83, 159, 0.8); }
        }
        
        .gradient-text {
            background: linear-gradient(45deg, #00539F, #FF6900, #00539F, #FF6900);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientShift 4s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .hover-float:hover {
            transform: translateY(-5px);
            transition: transform 0.3s ease;
        }

        /* Toast Notification */
        .toast {
            visibility: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease-in-out;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* Cores SENAI */
        .bg-primary { background-color: #00539F; }
        .bg-secondary { background-color: #FF6900; }
        .bg-accent { background-color: #003366; }
        .text-primary { color: #00539F; }
        .text-secondary { color: #FF6900; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Cabe√ßalho -->

        <header class="text-center mb-8 bounce-in relative flex flex-col items-center justify-center">
            <div class="flex items-center justify-center gap-2 w-full">
                <h1 class="text-4xl md:text-5xl font-extrabold gradient-text mb-2">üèÜ Agita Esportivo SENAI Mar√≠lia üèÜ</h1>
                <button id="rankingBtn" class="bg-secondary text-white p-3 rounded-full hover:bg-orange-600 transition-all shadow-lg ml-2 flex items-center" title="Ranking Geral">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17h4v-2.34"/><path d="M8 19h8"/><path d="M12 12v2.34"/><path d="m14 9-2-3-2 3"/><path d="M12 2v5.66"/></svg>
                </button>
            </div>
            <p class="text-lg md:text-xl text-gray-700 font-semibold">‚ö° Sistema de Pontua√ß√£o em Tempo Real ‚ö°</p>
        </header>

        <!-- Navega√ß√£o -->
        <nav class="flex justify-center items-center mb-8 gap-4">
            <button id="homeBtn" class="bg-primary text-white px-6 py-3 rounded-full font-bold hover:bg-blue-800 transition-all transform hover:scale-105 shadow-lg flex items-center gap-2 pulse-glow">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                In√≠cio
            </button>
        </nav>

        <!-- View Principal: In√≠cio -->
        <main id="homeView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Atividades ser√£o populadas via JavaScript -->
        </main>

        <!-- View: Detalhes da Atividade -->
        <section id="activityView" class="hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-5xl mx-auto border-t-8 border-primary">
                <div class="flex flex-col md:flex-row items-center justify-between mb-8 w-full">
                    <h2 id="activityTitle" class="text-3xl font-bold text-primary mb-4 md:mb-0 text-center md:text-left"></h2>
                    <div class="flex gap-2">
                        <button id="backBtn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-full hover:bg-gray-300 transition-all transform hover:scale-105 shadow-md flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                            Voltar
                        </button>
                        <button id="saveIconBtn" class="bg-green-600 text-white p-2 rounded-full hover:bg-green-700 transition-all shadow-md flex items-center" title="Salvar Pontua√ß√µes">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6" id="teamsGrid">
                    <!-- Times ser√£o populados via JavaScript -->
                </div>
                
                <div class="mt-8 flex justify-center">
                    <button id="saveScoresBtn" class="bg-green-600 text-white px-10 py-4 rounded-full font-bold hover:bg-green-700 transition-all transform hover:scale-105 shadow-lg pulse-glow flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Salvar Pontua√ß√µes
                    </button>
                </div>
            </div>
        </section>

        <!-- Modal de Senha -->
        <div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full border-t-8 border-primary bounce-in">
                <h3 class="text-2xl font-bold text-primary mb-6 text-center">üîí Acesso Restrito</h3>
                <p class="text-gray-600 mb-4 text-center">Digite a senha para visualizar o ranking:</p>
                <input type="password" id="passwordInput" class="w-full px-4 py-3 border-2 border-primary rounded-xl focus:outline-none focus:ring-4 focus:ring-primary/30 text-center text-lg font-bold mb-6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <div id="passwordError" class="hidden text-red-600 text-center mb-4 font-semibold">
                    Senha incorreta. Tente novamente.
                </div>
                <div class="flex gap-4">
                    <button id="cancelPasswordBtn" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-full hover:bg-gray-300 transition-all font-semibold">Cancelar</button>
                    <button id="confirmPasswordBtn" class="flex-1 bg-primary text-white px-6 py-3 rounded-full hover:bg-blue-800 transition-all font-bold">Confirmar</button>
                </div>
            </div>
        </div>

        <!-- View: Ranking -->
        <section id="rankingView" class="hidden">
            <div class="bg-white rounded-2xl shadow-2xl p-6 md:p-8 max-w-6xl mx-auto border-t-8 border-primary">
                <!-- Ranking Geral -->
                <div class="mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-center mb-8 text-primary">üèÜ Ranking Geral das Turmas üèÜ</h2>
                    <div id="rankingList" class="space-y-4">
                        <!-- Ranking geral ser√° populado via JavaScript -->
                    </div>
                </div>
                
                <!-- Rankings por Atividade -->
                <div>
                    <h3 class="text-2xl font-bold text-center mb-8 text-primary">üìä Rankings por Atividade</h3>
                    <div id="activityRankings" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Rankings individuais ser√£o populados via JavaScript -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Toast Notification -->
        <div id="toast" class="toast fixed bottom-5 right-5 bg-green-600 text-white px-6 py-3 rounded-full shadow-lg font-bold flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
            <span>Pontua√ß√µes salvas com sucesso!</span>
        </div>
    </div>
    
    <!-- Scripts Firebase -->
    <script type="module">
        // Importa√ß√µes do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DADOS E CONFIGURA√á√ÉO ---
        const activities = [
            "ESCALADA HORIZONTAL", "ATLETISMO", "BOLA AO CESTO", "GIN√ÅSTICA", "ARREMESSO AO ALVO", "CHINELO DE PAU", "PULAR CORDA", "DESAFIO DO TRAVESS√ÉO", "CORRER ENSACADO", "PULAR CORDA INDIVIDUAL", "DESAFIO DE EMBAIXADINHAS", "REVEZAMENTO MALUCO", "CORRIDA DE PARCEIROS", "CORRIDA DA COLHER", "CARRINHO DE M√ÉO HUMANO", "ARREMESSO NO COPO", "QUEBRA-CABE√áA", "MONTAGEM DA FRASE",
            "ENCERRAMENTO: PARTICIPA√á√ÉO (%)",
            "PARTICIPA√á√ÉO FESTA JUNINA (%)"
        ];
        const participationActivityIndex = activities.length - 2;
        const participationJuninaActivityIndex = activities.length - 1;
        const timeBasedActivities = [5, 8, 11, 12, 14]; // √çndices das atividades baseadas em tempo (come√ßa do 0)
        const teams = ["M1B", "T2B", "M2E", "T2C", "M2A", "T2A", "1QSD", "1AT", "2MM", "2MT", "1ETM", "1DTM", "2ETM", "2DTM", "1ADMM", "1ADMT", "T1AD"];
        const correctPassword = "aquelemario"; // Mantenha a senha como solicitado
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'agita-senai-marilia';

        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        // As configura√ß√µes do Firebase ser√£o injetadas automaticamente no ambiente de produ√ß√£o.
        // Para desenvolvimento local, substitua pelo seu objeto de configura√ß√£o.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAwI-bcZe-k9dv38LtQRfee25iSOWOCPqs",
            authDomain: "agita-esportivo.firebaseapp.com",
            projectId: "agita-esportivo",
            storageBucket: "agita-esportivo.appspot.com",
            messagingSenderId: "493917143963",
            appId: "1:493917143963:web:9e444bb6a5f7b16e1a573e"
        };
        
        // --- INICIALIZA√á√ÉO DO FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Habilita logs detalhados para depura√ß√£o

        // --- ESTADO DA APLICA√á√ÉO ---
        let scores = {};
        let currentActivity = null;
        let dbRef;

        // --- ELEMENTOS DO DOM ---
        const homeView = document.getElementById('homeView');
        const activityView = document.getElementById('activityView');
        const rankingView = document.getElementById('rankingView');
        const passwordModal = document.getElementById('passwordModal');
        const homeBtn = document.getElementById('homeBtn');
        const rankingBtn = document.getElementById('rankingBtn');
        const backBtn = document.getElementById('backBtn');
        const activityTitle = document.getElementById('activityTitle');
        const teamsGrid = document.getElementById('teamsGrid');
        const saveScoresBtn = document.getElementById('saveScoresBtn');
        const passwordInput = document.getElementById('passwordInput');
        const confirmPasswordBtn = document.getElementById('confirmPasswordBtn');
        const cancelPasswordBtn = document.getElementById('cancelPasswordBtn');
        const passwordError = document.getElementById('passwordError');
        const toast = document.getElementById('toast');

        // --- FUN√á√ïES DE NAVEGA√á√ÉO E VISUALIZA√á√ÉO ---
        function showView(viewToShow) {
            [homeView, activityView, rankingView, passwordModal].forEach(view => {
                view.classList.add('hidden');
            });
            viewToShow.classList.remove('hidden');
        }
        
        function showHome() {
            showView(homeView);
            renderActivities();
        }

        function showActivity(activityIndex) {
            currentActivity = activityIndex;
            showView(activityView);
            activityTitle.textContent = `${activityIndex + 1}. ${activities[activityIndex]}`;
            renderTeams();
        }

        function showPasswordModal() {
            passwordModal.classList.remove('hidden'); // Modal √© um overlay, n√£o oculta outras views
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            passwordInput.focus();
        }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---
        function renderActivities() {
            homeView.innerHTML = '';
            const colors = ['bg-primary', 'bg-secondary', 'bg-accent'];
            const emojis = ['üßó', 'üèÉ', 'üèÄ', 'ü§∏', 'üéØ', 'üëü', 'ü™¢', '‚öΩ', 'üèÉ‚Äç‚ôÇÔ∏è', 'ü™¢', '‚öΩ', 'üèÉ‚Äç‚ôÄÔ∏è', 'üë´', 'ü•Ñ', 'ü§ù', 'ü•§', 'üß©', 'üß©', 'üéâ','üçø'];
            
            activities.forEach((activity, index) => {
                const isCompleted = teams.some(team => scores[index]?.[team] > 0);
                const card = document.createElement('div');
                const row = Math.floor(index / 4);
                const colorClass = colors[row % colors.length];

                card.className = `rounded-xl shadow-lg hover:shadow-2xl transition-all cursor-pointer p-5 transform hover:scale-105 hover-float bounce-in relative overflow-hidden ${colorClass}`;
                card.style.animationDelay = `${index * 0.05}s`;
                card.innerHTML = `                   
                    <div class="flex items-center justify-between text-white">
                        <div class="flex-1">
                            <h3 class="text-base font-bold mb-1">${index + 1}. ${activity}</h3>
                            <p class="text-xs opacity-90">Clique para pontuar</p>
                        </div>
                        <div class="text-4xl ml-2">${emojis[index]}</div>
                    </div>
                `;
                card.addEventListener('click', () => showActivity(index));
                homeView.appendChild(card);
            });
        }

        function renderTeams() {
            teamsGrid.innerHTML = '';
            const isTimeBasedActivity = timeBasedActivities.includes(currentActivity);
            const isParticipationActivity = currentActivity === participationActivityIndex;
            const isParticipationJuninaActivity = currentActivity === participationJuninaActivityIndex;
            teams.forEach((team, index) => {
                const card = document.createElement('div');
                card.className = `bg-gray-50 rounded-lg p-3 border-2 border-gray-200 shadow-sm transform hover:scale-105 transition-all bounce-in`;
                card.style.animationDelay = `${index * 0.03}s`;
                const rawVal = scores[currentActivity]?.[team];
                let displayVal = '';
                if (isTimeBasedActivity && rawVal > 0) {
                    const minutes = Math.floor(rawVal / 60);
                    const seconds = Math.floor(rawVal % 60);
                    displayVal = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else if ((isParticipationActivity || isParticipationJuninaActivity) && rawVal > 0) {
                    displayVal = (typeof rawVal === 'number') ? rawVal.toFixed(2) : String(rawVal);
                } else if (!isTimeBasedActivity && !isParticipationActivity && !isParticipationJuninaActivity && rawVal > 0) {
                    displayVal = (typeof rawVal === 'number') ? rawVal.toFixed(2) : String(rawVal);
                }
                card.innerHTML = `
                    <label class="block text-sm font-bold text-gray-700 mb-2 text-center">${team}</label>
                    ${isTimeBasedActivity ? 
                        `<input 
                            type="text" 
                            pattern="[0-9]{2}:[0-9]{2}"
                            placeholder="00:00"
                            maxlength="5"
                            value="${displayVal}"
                            class="w-full p-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-center text-lg font-bold"
                            data-team="${team}"
                            oninput="this.value = this.value.replace(/[^0-9:]/g, '').replace(/(.*:.*):/, '$1')"
                            onkeypress="if(this.value.length === 2) this.value += ':'"
                        >` :
                        (isParticipationActivity || isParticipationJuninaActivity) ?
                        `<input 
                            type="number" 
                            min="0" max="100" step="0.01"
                            placeholder="%"
                            value="${displayVal}"
                            class="w-full p-2 border-2 border-blue-400 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent text-center text-lg font-bold"
                            data-team="${team}"
                        >` :
                        `<input 
                            type="number" 
                            min="0" 
                            step="0.01"
                            inputmode="decimal"
                            value="${displayVal}"
                            class="w-full p-2 border-2 border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-center text-lg font-bold"
                            data-team="${team}"
                        >`
                    }
                `;
                teamsGrid.appendChild(card);
            });
        }

        function renderRanking() {
            renderGeneralRanking();
            renderActivityRankings();
        }
        
        function renderGeneralRanking() {
            const teamTotals = {};
            teams.forEach(team => {
                teamTotals[team] = 0;
                activities.forEach((_, activityIndex) => {
                    if (timeBasedActivities.includes(activityIndex)) {
                        const activityScores = {};
                        teams.forEach(t => {
                            activityScores[t] = scores[activityIndex]?.[t] || 0;
                        });
                        const sortedTeams = Object.entries(activityScores)
                            .filter(([,score]) => score > 0)
                            .sort(([,a], [,b]) => a - b);
                        const position = sortedTeams.findIndex(([t]) => t === team) + 1;
                        if (position > 0) {
                            if (position === 1) teamTotals[team] += 150;
                            else if (position > 1 && position <= 8) teamTotals[team] += 150 - ((position - 1) * 10);
                            else teamTotals[team] += 70;
                        }
                    } else if (activityIndex === participationActivityIndex) {
                        const participationScores = {};
                        teams.forEach(t => {
                            participationScores[t] = scores[activityIndex]?.[t] || 0;
                        });
                        const sortedParticipation = Object.entries(participationScores)
                            .filter(([,perc]) => perc > 0)
                            .sort(([,a], [,b]) => b - a);
                        const pos = sortedParticipation.findIndex(([t]) => t === team) + 1;
                        if (pos > 0) {
                            if (pos === 1) teamTotals[team] += 400;
                            else if (pos > 1 && pos <= 17) teamTotals[team] += 400 - ((pos - 1) * 20);
                            else teamTotals[team] += 80;
                        }
                    } else if (activityIndex === participationJuninaActivityIndex) {
                        const participationJuninaScores = {};
                        teams.forEach(t => {
                            participationJuninaScores[t] = scores[activityIndex]?.[t] || 0;
                        });
                        const sortedJunina = Object.entries(participationJuninaScores)
                            .filter(([,perc]) => perc > 0)
                            .sort(([,a], [,b]) => b - a);
                        const posJunina = sortedJunina.findIndex(([t]) => t === team) + 1;
                        if (posJunina > 0) {
                            if (posJunina === 1) teamTotals[team] += 200;
                            else if (posJunina > 1 && posJunina <= 21) teamTotals[team] += 200 - ((posJunina - 1) * 10);
                            else teamTotals[team] += 10;
                        }
                    } else {
                        teamTotals[team] += scores[activityIndex]?.[team] || 0;
                    }
                });
            });
            
            const sortedTeams = Object.entries(teamTotals).sort(([,a], [,b]) => b - a);
            const rankingList = document.getElementById('rankingList');
            rankingList.innerHTML = '';
            
            sortedTeams.forEach(([team, total], index) => {
                const item = document.createElement('div');
                const position = index + 1;
                let medal = '', bgColor = 'bg-white', textColor = 'text-gray-800', specialClasses = 'border-gray-200';
                
                if (position === 1) { [medal, bgColor, textColor, specialClasses] = ['ü•á', 'bg-yellow-400', 'text-white', 'border-yellow-500 font-bold']; } 
                else if (position === 2) { [medal, bgColor, textColor, specialClasses] = ['ü•à', 'bg-gray-300', 'text-gray-900', 'border-gray-400 font-semibold']; } 
                else if (position === 3) { [medal, bgColor, textColor, specialClasses] = ['ü•â', 'bg-orange-400', 'text-white', 'border-orange-500 font-semibold']; }
                
                item.className = `flex items-center justify-between p-4 rounded-xl border-2 shadow-md transform hover:scale-105 transition-all bounce-in ${bgColor} ${specialClasses}`;
                item.style.animationDelay = `${index * 0.05}s`;
                item.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-3xl mr-4">${position}¬∫ ${medal}</span>
                        <span class="text-xl ${textColor}">${team}</span>
                    </div>
                    <div class="text-2xl font-bold ${textColor}">${total.toFixed(2)} pts</div>
                `;
                rankingList.appendChild(item);
            });
        }

        function renderActivityRankings() {
            const activityRankings = document.getElementById('activityRankings');
            activityRankings.innerHTML = '';

            activities.forEach((activity, activityIndex) => {
                const activityScores = {};
                teams.forEach(team => {
                    activityScores[team] = scores[activityIndex]?.[team] || 0;
                });

                const isTimeBasedActivity = timeBasedActivities.includes(activityIndex);
                const isParticipationActivity = activityIndex === participationActivityIndex;
                const isParticipationJuninaActivity = activityIndex === participationJuninaActivityIndex;
                let sortedTeams;
                if (isTimeBasedActivity) {
                    sortedTeams = Object.entries(activityScores)
                        .filter(([,score]) => score > 0)
                        .sort(([,a], [,b]) => a - b);
                } else if (isParticipationActivity || isParticipationJuninaActivity) {
                    sortedTeams = Object.entries(activityScores)
                        .filter(([,perc]) => perc > 0)
                        .sort(([,a], [,b]) => b - a);
                } else {
                    sortedTeams = Object.entries(activityScores)
                        .filter(([,score]) => score > 0)
                        .sort(([,a], [,b]) => b - a);
                }
                const rankingCard = document.createElement('div');
                rankingCard.className = 'bg-white rounded-xl shadow-md p-4 border-2 border-gray-200';
                const title = document.createElement('h4');
                title.className = 'text-lg font-bold mb-4 text-primary text-center';
                title.innerHTML = `${activityIndex + 1}. ${activity} ${isTimeBasedActivity ? '‚è±Ô∏è' : (isParticipationActivity || isParticipationJuninaActivity) ? 'üë•' : 'üéØ'}`;
                const list = document.createElement('div');
                list.className = 'space-y-2';
                sortedTeams.forEach(([team, score], index) => {
                    const item = document.createElement('div');
                    const position = index + 1;
                    const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : '';
                    const hasScore = score > 0;
                    item.className = `flex justify-between items-center py-1 px-2 rounded ${hasScore ? 'bg-gray-50' : 'bg-gray-50/50'}`;
                    let points = 0;
                    if (isTimeBasedActivity && hasScore) {
                        if (position === 1) points = 150;
                        else if (position > 1 && position <= 8) points = 150 - ((position - 1) * 10);
                        else points = 70;
                    }
                    if (isParticipationActivity && hasScore) {
                        if (position === 1) points = 400;
                        else if (position > 1 && position <= 17) points = 400 - ((position - 1) * 20);
                        else points = 80;
                    }
                    if (isParticipationJuninaActivity && hasScore) {
                        if (position === 1) points = 200;
                        else if (position > 1 && position <= 21) points = 200 - ((position - 1) * 10);
                        else points = 10;
                    }
                    item.innerHTML = `
                        <span class="font-semibold ${!hasScore ? 'text-gray-500' : ''}">${position}¬∫ ${medal} ${team}</span>
                        ${isTimeBasedActivity ? 
                            `<div class="text-right">
                                <div class="font-bold ${!hasScore ? 'text-gray-400' : 'text-blue-600'}">
                                    ${hasScore ? score.toFixed(2) + 's' : '-'}
                                </div>
                                ${hasScore ? `<div class="text-sm text-green-600">(${points} pts)</div>` : ''}
                            </div>` 
                        : (isParticipationActivity || isParticipationJuninaActivity) ?
                            `<div class="text-right">
                                <div class="font-bold ${!hasScore ? 'text-gray-400' : 'text-blue-600'}">
                                    ${hasScore ? score.toFixed(2) + '%' : '-'}
                                </div>
                                ${hasScore ? `<div class="text-sm text-green-600">(${points} pts)</div>` : ''}
                            </div>`
                        :
                            `<span class="font-bold ${!hasScore ? 'text-gray-400' : 'text-green-600'}">
                                ${hasScore ? score.toFixed(2) + ' pts' : '-'}
                            </span>`
                        }
                    `;
                    list.appendChild(item);
                });
                rankingCard.appendChild(title);
                rankingCard.appendChild(list);
                activityRankings.appendChild(rankingCard);
            });
        }

        // --- INTERA√á√ïES COM FIREBASE ---
        async function connectToFirestore() {
            await signInAnonymously(auth);
            dbRef = doc(db, "gincanas", appId);
            
            onSnapshot(dbRef, (docSnap) => {
                if (docSnap.exists()) {
                    scores = docSnap.data().scores || createInitialScores();
                    console.log("Dados recebidos do Firestore:", scores);
                } else {
                    console.log("Documento n√£o encontrado, criando um novo.");
                    scores = createInitialScores();
                    saveScoresToFirestore(true); // Salva a estrutura inicial
                }
                // Re-renderiza a view atual com os novos dados
                if (homeView.classList.contains('hidden') === false) renderActivities();
                if (rankingView.classList.contains('hidden') === false) renderRanking();
            });
        }
        
        function createInitialScores() {
            const initialScores = {};
            activities.forEach((_, index) => {
                initialScores[index] = {};
                teams.forEach(team => {
                    initialScores[index][team] = 0;
                });
            });
            return initialScores;
        }

        async function saveScoresToFirestore(isInitial = false) {
            if (!isInitial) {
                     const inputs = teamsGrid.querySelectorAll('input');
                     if (!scores[currentActivity]) scores[currentActivity] = {};
                    inputs.forEach(input => {
                        const team = input.dataset.team;
                        const isTimeBasedActivity = timeBasedActivities.includes(currentActivity);
                        const isParticipationActivity = currentActivity === participationActivityIndex;
                        const isParticipationJuninaActivity = currentActivity === participationJuninaActivityIndex;
                        if (isTimeBasedActivity) {
                            const timeString = input.value.trim();
                            if (timeString && /^\d{2}:\d{2}$/.test(timeString)) {
                                const [minutes, seconds] = timeString.split(':').map(Number);
                                scores[currentActivity][team] = minutes * 60 + seconds;
                            } else {
                                scores[currentActivity][team] = 0;
                            }
                        } else if (isParticipationActivity || isParticipationJuninaActivity) {
                            const raw = String(input.value).replace(',', '.').trim();
                            const parsed = parseFloat(raw);
                            scores[currentActivity][team] = Number.isFinite(parsed) ? parsed : 0;
                        } else {
                            const raw = String(input.value).replace(',', '.').trim();
                            const parsed = parseFloat(raw);
                            scores[currentActivity][team] = Number.isFinite(parsed) ? parsed : 0;
                        }
                    });
                }
           
            try {
                await setDoc(dbRef, { scores: scores });
                if (!isInitial) showToast("Pontua√ß√µes salvas com sucesso!");
            } catch (error) {
                console.error("Erro ao salvar no Firestore: ", error);
                showToast("Erro ao salvar. Verifique o console.", true);
            }
        }

        // --- L√ìGICA DE UI ADICIONAL ---
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = `toast show fixed bottom-5 right-5 text-white px-6 py-3 rounded-full shadow-lg font-bold ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function checkPassword() {
            if (passwordInput.value === correctPassword) {
                showView(rankingView);
                renderRanking();
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.classList.add('border-red-500');
                setTimeout(() => {
                    passwordError.classList.add('hidden');
                    passwordInput.classList.remove('border-red-500');
                }, 3000);
            }
        }

        // --- EVENT LISTENERS ---
        homeBtn.addEventListener('click', showHome);
        rankingBtn.addEventListener('click', showPasswordModal);
        backBtn.addEventListener('click', showHome);
        saveScoresBtn.addEventListener('click', () => saveScoresToFirestore(false));
        const saveIconBtn = document.getElementById('saveIconBtn');
        if (saveIconBtn) {
            saveIconBtn.addEventListener('click', () => saveScoresToFirestore(false));
        }
        confirmPasswordBtn.addEventListener('click', checkPassword);
        cancelPasswordBtn.addEventListener('click', () => passwordModal.classList.add('hidden'));
        passwordInput.addEventListener('keypress', (e) => e.key === 'Enter' && checkPassword());

        // --- INICIALIZA√á√ÉO DA APLICA√á√ÉO ---
        showHome();
        connectToFirestore();
    </script>
</body>
</html>
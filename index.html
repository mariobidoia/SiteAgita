<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roteiro de Atividades da Gincana</title>
    <!-- Incluindo o framework Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluindo a fonte Inter do Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { transition: opacity 0.3s ease-in-out; width: 100%; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
        /* Estilo para feedback visual durante carregamento */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.7); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        
        <!-- Tela 1: Seleção de Turma -->
        <div id="class-selection-view" class="view">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-blue-600">Roteiro de Atividades da Gincana</h1>
                <p class="text-gray-600 mt-2">Selecione sua turma para ver o cronograma e registrar as pontuações.</p>
            </header>
            <main>
                <div id="class-buttons" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                </div>
            </main>
        </div>

        <!-- Tela 2: Visualização do Roteiro -->
        <div id="schedule-view" class="view hidden">
            <header class="flex items-center justify-between mb-6 flex-wrap">
                <h2 id="schedule-title" class="text-2xl sm:text-3xl font-bold text-blue-700"></h2>
                <button id="back-button" class="mt-4 sm:mt-0 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    &larr; Voltar
                </button>
            </header>
            <main>
                <div id="schedule-list" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg min-h-[200px]">
                     <!-- Conteúdo dinâmico -->
                </div>
                <div class="mt-6 p-4 bg-blue-100 border-l-4 border-blue-500 rounded-lg shadow-md">
                    <p class="text-xl font-bold text-blue-800">
                        Pontuação Total: <span id="total-score">0</span>
                    </p>
                </div>
                <div class="mt-6 text-center">
                     <button id="save-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        Salvar Pontuações
                    </button>
                    <p id="save-feedback" class="text-green-600 mt-2 h-5 text-sm"></p>
                </div>
            </main>
        </div>
        
        <!-- Overlay de Carregamento -->
        <div id="loading" class="loading-overlay hidden">
            <p class="text-blue-600 font-semibold">Carregando...</p>
        </div>

    </div>

    <!-- Módulo para carregar e configurar o Firebase -->
    <script type="module">
        // Importações dos módulos do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INÍCIO DA LÓGICA DO SITE ---
        
        // =================================================================================
        // CONFIGURAÇÃO DO FIREBASE PARA USO LOCAL (VS CODE)
        // =================================================================================
        const localFirebaseConfig = {
            apiKey: "AIzaSyAwI-bcZe-k9dv38LtQRfee25iSOWOCPqs",
            authDomain: "agita-esportivo.firebaseapp.com",
            projectId: "agita-esportivo",
            storageBucket: "agita-esportivo.appspot.com", // Corrigido para o formato padrão do Firestore
            messagingSenderId: "493917143963",
            appId: "1:493917143963:web:9e444bb6a5f7b16e1a573e",
            measurementId: "G-GJC1DBQNZP"
        };
        // =================================================================================

        // 1. DADOS ESTÁTICOS
        const activities = { 1: "ESCALADA HORIZONTAL", 2: "ATLETISMO", 3: "BOLA AO CESTO", 4: "GINÁSTICA", 5: "ARREMESSO AO ALVO", 6: "CHINELO DE PAU", 7: "PULAR CORDA", 8: "DESAFIO DO TRAVESSÃO", 9: "CORRER ENSACADO", 10: "PULAR CORDA INDIVIDUAL", 11: "DESAFIO DE EMBAIXADINHAS", 12: "REVEZAMENTO MALUCO", 13: "CORRIDA DE PARCEIROS", 14: "CORRIDA DA COLHER", 15: "CARRINHO DE MÃO HUMANO", 16: "MONTAGEM DA FRASE", 17: "QUEBRA-CABEÇA", 18: "ARREMESSO NO COPO" };
        const classNames = ["M1B", "T2B", "M2E", "T2C", "M2A", "T2A", "1QSD", "1AT", "2MM", "2MT", "1ETM", "1DTM", "2ETM", "2DTM", "1ADMM", "1ADMT", "T1AD"];
        const schedules = { "M1B": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18], "T2B": [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1], "M2E": [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1, 2], "T2C": [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1, 2, 3], "M2A": [5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1, 2, 3, 4], "T2A": [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1, 2, 3, 4, 5], "1QSD": [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1, 2, 3, 4, 5, 6], "1AT": [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1, 2, 3, 4, 5, 6, 7], "2MM": [9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1, 2, 3, 4, 5, 6, 7, 8], "2MT": [10, 11, 12, 13, 14, 15, 16, 17, 18, 1, 2, 3, 4, 5, 6, 7, 8, 9], "1ETM": [11, 12, 13, 14, 15, 16, 17, 18, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10], "1DTM": [12, 13, 14, 15, 16, 17, 18, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11], "2ETM": [13, 14, 15, 16, 17, 18, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], "2DTM": [14, 15, 16, 17, 18, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13], "1ADMM": [15, 16, 17, 18, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14], "1ADMT": [16, 17, 18, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], "T1AD": [17, 18, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16] };
        
        let db, auth, appId;
        let currentClass = null;
        let unsubscribeFromScores = null;

        const classSelectionView = document.getElementById('class-selection-view');
        const scheduleView = document.getElementById('schedule-view');
        const classButtonsContainer = document.getElementById('class-buttons');
        const backButton = document.getElementById('back-button');
        const scheduleTitle = document.getElementById('schedule-title');
        const scheduleList = document.getElementById('schedule-list');
        const totalScoreEl = document.getElementById('total-score');
        const saveButton = document.getElementById('save-button');
        const saveFeedback = document.getElementById('save-feedback');
        const loadingOverlay = document.getElementById('loading');
        
        async function saveScoresToFirestore() {
            if (!currentClass || !db) return;
            
            const scoresToSave = {};
            const scoreInputs = scheduleList.querySelectorAll('.score-input');
            scoreInputs.forEach(input => {
                const round = input.dataset.round;
                const scoreValue = input.value;
                if (scoreValue !== "") {
                    scoresToSave[round] = Number(scoreValue);
                }
            });

            const docRef = doc(db, `artifacts/${appId}/public/data/scores`, currentClass);
            try {
                await setDoc(docRef, { scores: scoresToSave }, { merge: true });
                saveFeedback.textContent = 'Pontuação salva com sucesso!';
                setTimeout(() => { saveFeedback.textContent = ''; }, 2500);
            } catch (error) { // Correção aqui
                console.error("Erro ao salvar pontuação: ", error);
                saveFeedback.textContent = 'Erro ao salvar. Tente novamente.';
                setTimeout(() => { saveFeedback.textContent = ''; }, 2500);
            }
        }
        
        function listenForScoreChanges(className) {
            if (unsubscribeFromScores) unsubscribeFromScores();
            
            const docRef = doc(db, `artifacts/${appId}/public/data/scores`, className);
            unsubscribeFromScores = onSnapshot(docRef, (docSnap) => {
                const scoreData = docSnap.exists() ? docSnap.data().scores || {} : {};
                const scoreInputs = scheduleList.querySelectorAll('.score-input');
                let total = 0;
                
                scoreInputs.forEach(input => {
                    const round = input.dataset.round;
                    const savedScore = scoreData[round] || '';
                    if (document.activeElement !== input) {
                        input.value = savedScore;
                    }
                    total += Number(input.value) || 0;
                });
                
                totalScoreEl.textContent = total;
            });
        }
        
        function showView(viewToShow) {
            classSelectionView.classList.add('hidden');
            scheduleView.classList.add('hidden');
            viewToShow.classList.remove('hidden');
        }

        function displaySchedule(className) {
            currentClass = className;
            scheduleTitle.textContent = `Roteiro da Turma: ${className}`;
            const schedule = schedules[className];

            let html = '<ol class="list-inside space-y-4 text-gray-700">';
            schedule.forEach((activityId, index) => {
                const round = index + 1;
                const activityName = activities[activityId];
                html += `
                    <li class="p-3 bg-gray-100 rounded-lg border border-gray-200 flex justify-between items-center flex-wrap gap-2">
                        <div class="flex-grow pr-4">
                            <span class="font-semibold text-gray-800 block sm:inline">Rodada ${round}:</span>
                            <span class="text-sm sm:text-base"> Atividade ${activityId} - ${activityName}</span>
                        </div>
                        <input
                            type="number" min="0"
                            class="score-input w-28 p-2 border border-gray-300 rounded-md text-center shadow-sm focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Pontos" data-round="${round}"
                        >
                    </li>`;
            });
            html += '</ol>';
            scheduleList.innerHTML = html;
            
            listenForScoreChanges(className);
            showView(scheduleView);
            window.scrollTo(0, 0);
        }

        async function initializeAppAndAuth() {
            loadingOverlay.classList.remove('hidden');
            try {
                const runningOnPlatform = typeof __firebase_config !== 'undefined' && __firebase_config;
                
                const firebaseConfig = runningOnPlatform
                    ? JSON.parse(__firebase_config)
                    : localFirebaseConfig;

                appId = runningOnPlatform
                    ? __app_id
                    : 'gincana-local';

                if (!runningOnPlatform && (!firebaseConfig || !firebaseConfig.apiKey)) {
                    document.body.innerHTML = `
                        <div class="text-red-600 text-center p-8 max-w-2xl mx-auto bg-red-50 rounded-lg shadow-md">
                            <h2 class="font-bold text-xl mb-4">CONFIGURAÇÃO INCOMPLETA</h2>
                            <p>Para usar este aplicativo localmente, você precisa criar um projeto no Firebase e colar suas credenciais no código.</p>
                            <p class="mt-4 text-sm text-left text-gray-700">1. Vá para <a href="https://firebase.google.com/" target="_blank" class="text-blue-600 underline">firebase.google.com</a> e crie um novo projeto.<br>2. Adicione um "Aplicativo da Web" ao seu projeto.<br>3. Copie o objeto de configuração do Firebase.<br>4. Cole as credenciais dentro da variável <strong>localFirebaseConfig</strong> neste arquivo HTML.</p>
                        </div>`;
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (runningOnPlatform && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                classNames.forEach(className => {
                    const button = document.createElement('button');
                    button.textContent = className;
                    button.className = 'bg-white hover:bg-blue-500 hover:text-white text-blue-500 font-bold py-4 px-2 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 border-2 border-blue-200 hover:border-blue-500';
                    button.addEventListener('click', () => displaySchedule(className));
                    classButtonsContainer.appendChild(button);
                });

            } catch (error) {
                console.error("Falha na inicialização do Firebase:", error);
                document.body.innerHTML = `<p class="text-red-500 text-center p-8">Erro Crítico: Não foi possível conectar ao banco de dados. Verifique a configuração do Firebase.</p>`;
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        backButton.addEventListener('click', () => {
            if (unsubscribeFromScores) unsubscribeFromScores();
            currentClass = null;
            showView(classSelectionView);
        });
        saveButton.addEventListener('click', saveScoresToFirestore);

        initializeAppAndAuth();

    </script>
</body>
</html>